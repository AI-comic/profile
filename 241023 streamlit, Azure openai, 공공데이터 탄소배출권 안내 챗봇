import streamlit as st
import json
import requests
import openai

# OpenAI API ì„¤ì •
openai.api_type = "azure"
openai.api_base = "https://st008openai.openai.azure.com/"
openai.api_version = "2023-05-15"
openai.api_key = "í‚¤ ì…ë ¥ ê³µê°„"  # Azure OpenAI í‚¤

# íƒ„ì†Œë°°ì¶œê¶Œ ë°ì´í„° ì¡°íšŒ í•¨ìˆ˜
def get_carbon_credit_data():
    url = 'http://apis.data.go.kr/1160100/service/GetGeneralProductInfoService/getCertifiedEmissionReductionPriceInfo'
    params = {
        'serviceKey': 'í‚¤ ì…ë ¥ ê³µê°„', # ê³µê³µë°ì´í„° í‚¤
        'resultType': 'json',
        'numOfRows': '100',
        'pageNo': '1',
    }
    try:
        response = requests.get(url, params=params)
        content = response.content.decode('utf-8')
        data = json.loads(content)
        return data
    except Exception as e:
        st.error(f"ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
        return None

# ë°ì´í„° íŒŒì‹± í•¨ìˆ˜
def parse_carbon_credit_data(data):
    items = data['response']['body']['items']['item']
    carbon_credit_info = []
    for item in items:
        info = {
            'ê¸°ì¤€ì¼ì': item.get('basDt'),
            'ë‹¨ì¶•ì½”ë“œ': item.get('srtnCd'),
            'ISINì½”ë“œ': item.get('isinCd'),
            'ì¢…ëª©ëª…': item.get('itmsNm'),
            'ì¢…ê°€': item.get('clpr'),
            'ëŒ€ë¹„': item.get('vs'),
            'ë“±ë½ë¥ ': item.get('fltRt'),
            'ê±°ë˜ëŸ‰': item.get('trqu'),
            'ê±°ë˜ëŒ€ê¸ˆ': item.get('trPrc'),
            'ìµœê³ ê°€': item.get('hipr'),
            'ìµœì €ê°€': item.get('lopr'),
            'ì‹œì‘ê°€': item.get('mkp'),
        }
        carbon_credit_info.append(info)
    return carbon_credit_info

# ë©”ì¸ ì•±
def main():
    st.set_page_config(page_title="íƒ„ì†Œë°°ì¶œê¶Œ ì •ë³´ ì±—ë´‡", layout="wide")
    st.title("ğŸŒ íƒ„ì†Œë°°ì¶œê¶Œ ì •ë³´ ì œê³µ ì±—ë´‡")
    st.markdown("""**ì•ˆë…•í•˜ì„¸ìš”!**
                í™•ì¸í•˜ê³  ì‹¶ì€ íƒ„ì†Œë°°ì¶œê¶Œ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.""")

    query = st.text_input("ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì„¸ìš”â“", max_chars=50)

    if st.button("ì •ë³´ ì¡°íšŒ"):
        data = get_carbon_credit_data()
        if data:
            carbon_credit_info = parse_carbon_credit_data(data)

            documents = [
                ", ".join([f"{key}: {str(info[key])}" for key in ['ë‹¨ì¶•ì½”ë“œ', 'ê¸°ì¤€ì¼ì', 'ì¢…ëª©ëª…', 'ì¢…ê°€', 'ê±°ë˜ëŸ‰', 'ê±°ë˜ëŒ€ê¸ˆ', 'ë“±ë½ë¥ ', 'ëŒ€ë¹„', 'ìµœê³ ê°€', 'ìµœì €ê°€', 'ì‹œì‘ê°€']])
                for info in carbon_credit_info
            ]

            if query:
                # ê²€ìƒ‰ëœ ë¬¸ì„œ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ OpenAI API í˜¸ì¶œ
                context = "\n".join(documents)
                prompt = f"""
                ë‹¤ìŒ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸ì— ë‹µë³€í•˜ì„¸ìš”:
                {context}

                ì§ˆë¬¸: {query}
                """

                # OpenAI API í˜¸ì¶œ (ìµœì‹  ë°©ì‹)
                response = openai.ChatCompletion.create(
                    engine="gpt-4o",
                    messages=[
                        {"role": "user", "content": prompt}
                    ]
                )
                answer = response['choices'][0]['message']['content']
                st.markdown("**ì±—ë´‡ì˜ ë‹µë³€:**")
                st.markdown(answer)

if __name__ == "__main__":
    main()
