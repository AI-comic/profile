# GitOps를 이용한 배포 서비스 자동화

## 목표

> * **GitOps**의 개념과 필요성을 이해한다.
> * **CI/CD 파이프라인**의 동작 흐름을 이해하고 GitHub Actions으로 CI를 구현한다.
> * **ArgoCD**를 이용하여 Kubernetes 기반 CD(배포 자동화)를 구축한다.

---

## 핵심 키워드

| 구분                 | 키워드                                            | 설명                                    |
| ------------------ | ---------------------------------------------- | ------------------------------------- |
| **CI/CD**          | Continuous Integration / Continuous Deployment | 지속적 통합 및 지속적 배포를 의미                   |
| **GitOps**         | Git 중심의 배포 자동화 방식                              | Git 리포지토리를 인프라 및 애플리케이션 배포의 단일 소스로 사용 |
| **GitHub Actions** | CI 자동화 도구                                      | 코드 빌드, 테스트, 이미지 푸시 등 자동 수행            |
| **ArgoCD**         | CD 자동화 도구                                      | Git 상태를 감시하여 클러스터와 동기화, 자동 배포 수행      |

---

## 1. GitOps란?

GitOps는 **Git 리포지토리를 단일 진실 원본(Single Source of Truth)** 으로 두고,
배포와 운영까지 자동화하는 **DevOps 확장 개념**이다.

### 핵심 개념

* **모든 설정과 코드가 Git에 저장**된다.
* 운영 환경은 **Git 상태와 항상 동기화**된다.
* 배포는 `git push` 로 시작된다.
* 수동 명령(`kubectl apply`) 대신, **자동 감시 및 반영**이 이루어진다.

### 장점

* 변경 이력 추적 용이
* 배포 표준화 및 자동화
* 인적 오류 감소
* 롤백(Rollback) 간편

---

## 2. CI/CD 개요

GitOps 환경에서는 CI와 CD가 다음과 같이 분리된다.

| 단계                              | 도구             | 역할                                          |
| ------------------------------- | -------------- | ------------------------------------------- |
| **CI (Continuous Integration)** | GitHub Actions | 코드 빌드, 테스트, 이미지 생성 및 푸시                     |
| **CD (Continuous Deployment)**  | ArgoCD         | Git 저장소를 감시하고 변경 사항을 Kubernetes 클러스터에 자동 반영 |

---

## 3. GitHub Actions으로 CI 구현

GitHub Actions는 GitHub 저장소 내 `.github/workflows` 디렉터리에 **YAML 파일**을 두어
자동 빌드, 테스트, 배포를 정의한다.

### 예시 디렉터리 구조

```
my-app/
├── .github/
│   └── workflows/
│       └── ci.yaml
├── Dockerfile
└── app.py
```

### CI 워크플로우 예시

```yaml
name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Docker 빌드
        run: docker build -t ghcr.io/${{ github.repository }}:latest .

      - name: GitHub Container Registry 로그인
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 이미지 푸시
        run: docker push ghcr.io/${{ github.repository }}:latest
```

> 위 작업은 **main 브랜치에 push**될 때마다 자동으로 트리거되어
>
> * Docker 이미지를 빌드하고
> * GitHub Container Registry(GHCR)에 업로드한다.

---

## 4. ArgoCD로 CD(배포 자동화) 구현

### ArgoCD란?

ArgoCD는 **Kubernetes용 GitOps CD 도구**로,
Git에 정의된 상태(Deployment, Service 등 YAML 파일)를
Kubernetes 클러스터와 자동으로 동기화한다.

### 동작 방식

1. GitHub 리포지토리에 **Kubernetes 매니페스트(YAML)** 저장
2. ArgoCD가 Git 리포지토리 변경 감시
3. 변경이 발생하면 자동으로 Kubernetes 클러스터에 적용

---

## 5. ArgoCD 배포 구성 예시

### Git 리포지토리 구조

```
gitops-app/
├── manifests/
│   ├── deployment.yaml
│   ├── service.yaml
│   └── ingress.yaml
└── argocd/
    └── application.yaml
```

### ArgoCD Application 예시

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-app
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'https://github.com/username/gitops-app.git'
    targetRevision: main
    path: manifests
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: my-app
  syncPolicy:
    automated:
      prune: true        # 불필요한 리소스 자동 삭제
      selfHeal: true     # 수동 변경 자동 복구
```

> ArgoCD가 `manifests/` 디렉터리를 감시하며,
> 코드 변경 시 자동으로 클러스터 상태를 Git과 일치시킨다.

---

## 6. GitOps 배포 흐름 요약

```
개발자 → GitHub Push → (CI) GitHub Actions → Docker Build & Push → (CD) ArgoCD Sync → Kubernetes 배포
```

1. 개발자가 코드를 변경하고 `git push`
2. GitHub Actions가 **Docker 이미지 빌드 및 푸시**
3. ArgoCD가 Git 변경을 감지
4. Kubernetes에 자동 배포 및 동기화 완료

---

## 7. 운영 팁

| 구분                 | 권장 설정                          | 이유                               |
| ------------------ | ------------------------------ | -------------------------------- |
| Secrets            | GitHub → Settings → Secrets 등록 | 민감한 값(Access Token, Password) 보호 |
| Branch Protection  | main 브랜치 보호                    | 실수로 인한 배포 방지                     |
| ArgoCD SelfHeal    | `true` 설정                      | 클러스터 상태 자동 복원                    |
| ArgoCD Sync Policy | `automated` 사용                 | 완전 자동 배포 구현 가능                   |

---

## 8. 학습 정리

| 구분                 | 도구        | 주요 역할                  |
| ------------------ | --------- | ---------------------- |
| **Git**            | 버전 관리 시스템 | 코드 및 설정의 단일 진실 원본      |
| **GitHub Actions** | CI 자동화    | 테스트, 빌드, 이미지 푸시        |
| **ArgoCD**         | CD 자동화    | Git → Kubernetes 자동 반영 |

---

## 9. 다음 단계 제안

* Terraform으로 구성한 인프라에 ArgoCD를 결합
* Helm Chart를 이용한 애플리케이션 배포
* GitOps 파이프라인에서 **Multi-Cluster 운영 구조** 실습

---

## 참고 문서

* [GitOps 공식 문서](https://www.gitops.tech/)
* [GitHub Actions Documentation](https://docs.github.com/actions)
* [ArgoCD 공식 문서](https://argo-cd.readthedocs.io/en/stable/)

