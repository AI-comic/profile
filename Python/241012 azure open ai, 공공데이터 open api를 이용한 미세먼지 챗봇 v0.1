import streamlit as st
import json
import requests
from langchain.embeddings import SentenceTransformerEmbeddings
from langchain.vectorstores import FAISS
from langchain.chains import LLMChain
from langchain.prompts import ChatPromptTemplate
from langchain.chat_models import ChatOpenAI
from langchain.text_splitter import RecursiveCharacterTextSplitter

def request_chatgpt(input_text, histories, system_text):
    api_key = "í‚¤ë¥¼ ì…ë ¥í•˜ëŠ” ê³µê°„"     
    ENDPOINT_URL = "ENDPOINT URLì„ ì…ë ¥í•˜ëŠ” ê³µê°„ê°„"
    
    headers = {
        "Content-type": "application/json",
        "api-key": api_key
    }
    
    messages = [{"role": "system", "content": system_text}]
    
    for history in histories:
        messages.append({"role": "assistant", "content": history[0]})
        messages.append({"role": "user", "content": history[1]})
    
    user_message = {"role": "user", "content": input_text}
    messages.append(user_message)
    
    body = {
        "temperature": 0.7,
        "top_p": 0.95,
        "max_tokens": 800,
        "messages": messages
    }
    
    response = requests.post(ENDPOINT_URL, headers=headers, json=body)
    
    if response.status_code == 200:
        response_text = response.json()['choices'][0]['message']['content']
        return response_text
    else:
        print(response.text)
        return None  

def get_air_quality_data(sido):
    url = 'http://apis.data.go.kr/B552584/ArpltnInforInqireSvc/getCtprvnRltmMesureDnsty'
    params = {
        'serviceKey': 'í‚¤ë¥¼ ì…ë ¥í•˜ëŠ” ê³µê°„',
        'returnType': 'json', 
        'numOfRows': '100', 
        'pageNo': '1', 
        'sidoName': sido, 
        'ver': '1.0'
    }
    response = requests.get(url, params=params)
    data = response.json()
    return data

def parse_air_quality_data(data):
    items = data['response']['body']['items']
    air_quality_info = []
    for item in items:
        info = {
            'ì¸¡ì •ì†Œëª…': item.get('stationName'),
            'ë‚ ì§œ': item.get('dataTime'),
            'ë¯¸ì„¸ë¨¼ì§€ë†ë„': item.get('pm10Value'),
            'ì´ˆë¯¸ì„¸ë¨¼ì§€ë†ë„': item.get('pm25Value'),
            'í†µí•©ëŒ€ê¸°í™˜ê²½ìˆ˜ì¹˜': item.get('khaiValue')
        }
        air_quality_info.append(info)
    return air_quality_info

def main():
    st.set_page_config(page_title="ëŒ€ê¸°ì§ˆ ì •ë³´ ì±—ë´‡", layout="wide")
    st.title("ğŸŒ ëŒ€ê¸°ì§ˆ ì •ë³´ ì œê³µ ì±—ë´‡")
    
    sido = st.text_input("ğŸ“ ë„ì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "ì„œìš¸", max_chars=10)
    query = st.text_input("â“ ê¶ê¸ˆí•œ ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš”:", "ìš©ì‚°êµ¬", max_chars=10)
    
    if st.button("ì§€ì—­ ì„ íƒ"):
        data = get_air_quality_data(sido)
        air_quality_info = parse_air_quality_data(data)

        documents = [
            {"page_content": ", ".join([f"{key}: {info[key]}" for key in ['ì¸¡ì •ì†Œëª…', 'ë‚ ì§œ', 'ë¯¸ì„¸ë¨¼ì§€ë†ë„', 'ì´ˆë¯¸ì„¸ë¨¼ì§€ë†ë„', 'í†µí•©ëŒ€ê¸°í™˜ê²½ìˆ˜ì¹˜']])} 
            for info in air_quality_info
        ]

        text_splitter = RecursiveCharacterTextSplitter(separators=",")
        docs = text_splitter.split_documents(documents)

        embedding_function = SentenceTransformerEmbeddings(model_name="jhgan/ko-sroberta-multitask")
        db = FAISS.from_documents(docs, embedding_function)

        if query:
            retriever = db.as_retriever(search_type="similarity", search_kwargs={'k': 5})
            query_result = retriever.get_relevant_documents(query)
            st.write("**DB ê²€ìƒ‰ ê²°ê³¼:**", query_result[0].page_content if query_result else "ê²°ê³¼ ì—†ìŒ")

            # ì±—ë´‡ ì„¤ì •
            llm = ChatOpenAI(model="gemma2:9b", temperature=0.3)

            template = """
            ë‹¹ì‹ ì€ ëŒ€ê¸°ì§ˆì„ ì•ˆë‚´í•˜ëŠ” ì±—ë´‡ì…ë‹ˆë‹¤. 
            ì‚¬ìš©ìì—ê²Œ ê°€ëŠ¥í•œ ë§ì€ ì •ë³´ë¥¼ ì¹œì ˆí•˜ê²Œ ì œê³µí•˜ì‹­ì‹œì˜¤.            
            ë‹¤ìŒì˜ ê¸°ì¤€ìœ¼ë¡œ, ê³µê¸°ê°€ ì¢‹ìŒ, ë³´í†µ, ë‚˜ì¨, ë§¤ìš° ë‚˜ì¨ì„ íŒë³„í•´ì£¼ì„¸ìš”. 
            
            PM10 (ë¯¸ì„¸ë¨¼ì§€ ë†ë„)
                ì¢‹ìŒ: 0 ~ 30 
                ë³´í†µ: 31 ~ 80
                ë‚˜ì¨: 81 ~ 150 
                ë§¤ìš° ë‚˜ì¨: 151 ì´ìƒ
            PM2.5 (ì´ˆë¯¸ì„¸ë¨¼ì§€ ë†ë„)
                ì¢‹ìŒ: 0 ~ 15 
                ë³´í†µ: 16 ~ 35 
                ë‚˜ì¨: 36 ~ 75 
                ë§¤ìš° ë‚˜ì¨: 76 ì´ìƒ
            
            Answer the question based on the following context:
            {context}

            Question: {question}
            """
            prompt = ChatPromptTemplate.from_template(template)

            chain = LLMChain(llm=llm, prompt=prompt)

            if query_result:
                response = chain.invoke({'context': query_result[0].page_content, 'question': query})
                st.markdown("**ì±—ë´‡ì˜ ë‹µë³€:**")
                st.markdown(response.content)

if __name__ == "__main__":
    main()
